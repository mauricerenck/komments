(function(){"use strict";function o(n,t,e,a,s,i,l,c){var r=typeof n=="function"?n.options:n;return t&&(r.render=t,r.staticRenderFns=e,r._compiled=!0),{exports:n,options:r}}const d={props:{queuedKomments:Object,affectedPages:Array,webmentions:Boolean}};var p=function(){var t=this,e=t._self._c;return e("k-inside",[e("div",{staticClass:"k-komments-view"},[e("k-headline",{attrs:{tag:"h2"}},[t._v("Comments")]),e("CommentsTable",{attrs:{comments:this.queuedKomments,affectedPages:this.affectedPages,webmentions:this.webmentions}}),e("k-headline",{attrs:{tag:"h2"}},[t._v("Converter")]),e("Converter")],1)])},u=[],h=o(d,p,u);const v=h.exports,_={mixins:["drawer"],props:{comment:{type:Object,default:{}}}};var g=function(){var t=this,e=t._self._c;return e("k-drawer",t._b({},"k-drawer",t.$props,!1),[e("CommentContent",{attrs:{spamlevel:t.comment.spamlevel,content:t.comment.content}}),e("div",{staticClass:"k-table"},[e("table",{staticStyle:{"table-layout":"auto"}},[e("tbody",[e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Id")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.id))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Type")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.type))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Language")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.language))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Published")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.published))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Verified")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.verified))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Reply To")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.parentid))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Spam level")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.spamlevel))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Upvotes")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.upvotes))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Downvotes")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.downvotes))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Created at")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.createdat))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Updated at")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.updatedat))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Permalink")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.permalink))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Author")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.authorname))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Avatar")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.authoravatar))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Email")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.authoremail))])]),e("tr",[e("th",{attrs:{"data-mobile":"true"}},[t._v("Url")]),e("td",{attrs:{"data-mobile":"true"}},[t._v(t._s(t.comment.authorurl))])])])])])],1)},b=[],f=o(_,g,b);const y=f.exports,C={mixins:["drawer"],props:{comment:{type:Object,default:{}}},data(){return{originPublished:this.comment.published,replyCreated:null,isSending:!1}},methods:{sendReply(){this.isSending=!0,panel.api.post(`komments/reply/${this.comment.id}`,{content:this.content,pageUuid:this.comment.pageuuid,language:this.comment.language}).then(n=>{this.originPublished=n.published,this.replyCreated=n.created,this.isSending=!1}).catch(()=>{this.replyCreated=!1,this.isSending=!1})}}};var k=function(){var t=this,e=t._self._c;return e("k-drawer",t._b({},"k-drawer",t.$props,!1),[this.originPublished?t._e():e("k-box",{key:"unpublished",staticStyle:{"margin-bottom":"var(--spacing-6)"},attrs:{theme:"notice",text:"This comment is not published yet. When you reply, it will be published along with your reply."}}),this.replyCreated?e("k-box",{key:"created",staticStyle:{"margin-bottom":"var(--spacing-6)"},attrs:{theme:"positive",text:"Your reply has been published."}}):this.replyCreated===!1?e("k-box",{key:"not-created",staticStyle:{"margin-bottom":"var(--spacing-6)"},attrs:{theme:"negative",text:"Your reply could not be published. Please try again."}}):t._e(),e("CommentContent",{attrs:{spamlevel:t.comment.spamlevel,content:t.comment.content}}),e("k-writer-field",{staticStyle:{"margin-bottom":"var(--spacing-1)"},attrs:{autofocus:!0,label:`Reply to ${t.comment.authorname}`,value:t.content},on:{input:function(a){t.content=a}}}),e("k-button",{key:"green",attrs:{theme:"green",variant:"filled",icon:t.isSending?t.loader:null,disabled:t.isSending},on:{click:this.sendReply}},[t._v(" Send reply ")])],1)},w=[],x=o(C,k,w);const $=x.exports,S={props:{icon:String,color:String}};var T=function(){var t=this,e=t._self._c;return e("svg",{staticClass:"k-icon",style:`color: var(${this.color})`,attrs:{"aria-hidden":"true","data-type":this.icon}},[e("use",{attrs:{"xlink:href":`#icon-${this.icon}`}})])},L=[],R=o(S,T,L);const U=R.exports,P={props:{spamlevel:Number,content:String}};var I=function(){var t=this,e=t._self._c;return e("div",[t.spamlevel>0?e("k-box",{key:"spam",staticStyle:{"margin-bottom":"var(--spacing-6)"},attrs:{theme:"warning",text:"This comment is marked as spam. Its content is shown as plain text to prevent accidental exposure to harmful content."}}):t._e(),e("k-box",{staticStyle:{"margin-bottom":"var(--spacing-6)"},attrs:{theme:"text"}},[t.spamlevel===0?e("k-text",{domProps:{innerHTML:t._s(t.content)}}):e("k-text",[t._v(t._s(t.content))])],1)],1)},V=[],D=o(P,I,V);const M=D.exports,F={props:{comments:Object,affectedPages:Array,columns:Array,webmentions:Boolean},data(){return{pagination:{page:1,limit:20,total:0}}},computed:{index(){return(this.pagination.page-1)*this.pagination.limit+1},visibleColumns(){const n=["author","content","pageTitle","updatedAt","spamlevel","verified","published","type"],e=[...this.columns||n].filter(s=>n.includes(s)),a={author:{label:"Author",type:"html"},content:{label:"Comment",type:"text"},pageTitle:{label:"Page",type:"html"},updatedAt:{label:"Last Update",type:"html"},spamlevel:{label:"Spamlevel",type:"html",width:"40px",align:"center"},verified:{label:"Verified",type:"html",width:"40px",align:"center"},published:{label:"Published",type:"html",width:"40px",align:"center"},type:{label:"Type",type:"html",width:"40px",align:"center"}};return Object.fromEntries(e.map(s=>[s,a[s]]))},commentList(){const n={comment:"chat","in-reply-to":"megaphone","repost-of":"indie-repost","mention-of":"indie-mention","like-of":"heart","bookmark-of":"bookmark",rsvp:"calendar",invite:"calendar"},t={"in-reply-to":"Webmention reply","repost-of":"Webmention repost","mention-of":"Webmention mention","like-of":"Webmention like","bookmark-of":"Webmention bookmark",rsvp:"Webmention RSVP",invite:"Webmention invite"},e=[];return this.pagination.total=0,(this.webmentions?this.comments:this.comments.filter(s=>s.type==="comment")).forEach(s=>{const i=this.affectedPages.find(B=>B.uuid===s.pageuuid),l=s.content?s.content.replace(/<[^>]*>/g,""):`(${t[s.type]})`,c=this.$library.dayjs.pattern("YYYY-MM-DD HH:mm").format(this.$library.dayjs(s.updatedat)),r={id:s.id,pageTitle:`<a href="${i.panel}">${i.title}</a>`,author:`<span class="author-entry"><img src="${s.authoravatar}" width="30px" height="30px" />${s.authorname}</span>`,content:l,updatedAt:c,type:this.tableIcon(n[s.type],"--color-blue-700",s.type),spamlevel:s.spamlevel>0?this.tableIcon("flag","--color-red-700"):"",verified:s.verified?this.tableIcon("sparkling","--color-yellow-700"):"",published:s.published?this.tableIcon("preview","--color-green-700"):this.tableIcon("hidden","--color-red-700")};e.push(r),this.pagination.total++}),e.slice(this.index-1,this.pagination.limit*this.pagination.page)}},methods:{showCommentDetails(n){const t=this.comments.find(e=>e.id===n);panel.drawer.open({component:"komments-detail-drawer",props:{icon:"info",title:"Comment",comment:t}})},replyToComment(n){const t=this.comments.find(e=>e.id===n);panel.drawer.open({component:"komments-reply-drawer",props:{icon:"chat",title:"Reply to comment",comment:t}})},publishComment(n){panel.api.post(`komments/publish/${n}`).then(t=>{this.comments.find(e=>e.id===n).published=t.published})},deleteComment(n){panel.dialog.open(`comment/delete/${n}`)},flagComment(n,t){panel.api.post(`komments/flag/${n}/${t}`).then(e=>{this.comments.find(a=>a.id===n)[t]=e[t]})},dropdownOptions(n){const t=this.comments.find(e=>e.id===n.id);return[{label:t.published?"Unpublish":"Publish",icon:t.published?"toggle-on":"toggle-off",click:()=>this.publishComment(n.id)},{label:"Reply to",icon:"chat",click:()=>this.replyToComment(n.id)},"-",{label:t.verified?"Mark as unverified":"Mark as verified",icon:t.verified?"cancel-small":"sparkling",disabled:t.spamlevel>0,click:()=>this.flagComment(n.id,"verified")},{label:t.spamlevel>0?"Remove from spam":"Mark as spam"+n.spamlevel,icon:t.spamlevel>0?"cancel-small":"flag",click:()=>this.flagComment(n.id,"spamlevel")},{label:"View Details",icon:"info",click:()=>this.showCommentDetails(n.id)},"-",{label:"Delete",icon:"trash",click:()=>this.deleteComment(n.id)}]},tableIcon(n,t,e=""){return`<span title="${e}"><svg aria-hidden="true" data-type="${n}" class="k-icon" style="color: var(${t});"><use xlink:href="#icon-${n}"></use></svg></span>`}}};var H=function(){var t=this,e=t._self._c;return e("div",{staticClass:"k-komments-view"},[e("k-table",{attrs:{columns:this.visibleColumns,index:!0,rows:this.commentList,empty:"No comments found",pagination:{page:t.pagination.page,limit:t.pagination.limit,total:t.pagination.total,details:!0}},on:{paginate:function(a){t.pagination.page=a.page}},scopedSlots:t._u([{key:"header",fn:function({columnIndex:a,label:s}){return[e("span",{attrs:{title:s}},[a==="verified"?e("k-icon",{staticStyle:{color:"var(--color-yellow-700)"},attrs:{type:"sparkling"}}):a==="spamlevel"?e("k-icon",{staticStyle:{color:"var(--color-red-700)"},attrs:{type:"flag"}}):a==="published"?e("k-icon",{staticStyle:{color:"var(--color-green-700)"},attrs:{type:"preview"}}):a==="type"?e("k-icon",{staticStyle:{color:"var(--color-blue-700)"},attrs:{type:"box"}}):e("span",[t._v(t._s(s))])],1)]}},{key:"options",fn:function({row:a}){return[e("k-options-dropdown",{attrs:{options:t.dropdownOptions(a)}})]}}])})],1)},O=[],A=o(F,H,O);const m=A.exports,q={props:{},data(){return{status:"idle",comments:[],queue:[],processIndex:0,processRunning:!1}},computed:{conversionList(){return this.comments.map(n=>({conversionStatus:`<span class="status ${n.conversionStatus}">${n.conversionStatus}</span>`,pageUuid:n.pageUuid,pageTitle:n.pageTitle,comments:n.comments,converted:n.converted,failed:n.failed}))}},methods:{getComments(){this.status="in-progress",panel.api.get("komments/converter/get-comments").then(n=>{const t=[];n.forEach(e=>{const a={...e,queueStatus:"idle"};this.queue.push(a);const s=t.find(l=>l.pageUuid===e.pageUuid);if(s){s.comments++;return}const i={conversionStatus:"idle",pageUuid:e.pageUuid,pageTitle:e.pageTitle,comments:1,converted:0,failed:0};t.push(i)}),this.comments=t,this.processQueue()})},processQueue(){if(this.processIndex>=this.queue.length){this.processIndex=0,this.processRunning=!1;return}this.processRunning=!0;const t=this.queue[this.processIndex];this.processIndex+=1;const e=this.comments.find(a=>t.pageUuid===a.pageUuid);e.conversionStatus="running",panel.api.post("komments/converter/convert",t).then(a=>{const s=this.comments.find(i=>t.pageUuid===i.pageUuid);a.status==="success"?s.converted++:s.failed++,e.conversionStatus=s.comments.length===s.converted+s.failed?"success":"done"}).then(()=>{this.processQueue()})},convertComment(n){const t=this.comments.find(e=>e.pageUuid===n.pageUuid);t.conversionStatus="running",panel.api.post("komments/converter/convert",n).then(e=>{console.log(e);const a=this.comments.find(s=>s.pageUuid===n.pageUuid);e.status==="success"?a.converted++:a.failed++}).then(()=>{})}}};var W=function(){var t=this,e=t._self._c;return e("div",{staticClass:"sdfsd"},[t._v(" It seems like you used an older version of this plugin. We need to convert old comments to the new format. This will take a while. For data safety reasons, we will not delete the old comments. You can delete them manually after the conversion. "),e("button",{on:{click:t.getComments}},[t._v("Convert")]),t.status==="in-progress"?e("div",[e("k-box",{key:"inprogress",staticStyle:{"margin-bottom":"var(--spacing-6)"},attrs:{theme:"warning",text:"Conversion in progress, please wait. DO NOT CLOSE THIS PAGE."}}),t._v(" Found "+t._s(t.queue.length)+" comments. "),e("k-table",{attrs:{columns:{conversionStatus:{label:"Status",width:"160px",type:"html"},pageTitle:{label:"Page",type:"html"},comments:{label:"Comments",type:"text"},converted:{label:"Converted",type:"text"},failed:{label:"Failed",type:"text"}},index:!0,rows:t.conversionList,empty:"No comments found"}})],1):t._e()])},j=[],Y=o(q,W,j);const E=Y.exports;panel.plugin("mauricerenck/komments",{components:{"k-komments-view":v,CommentContent:M,CommentsTable:m,Converter:E,TableIcon:U,"komments-detail-drawer":y,"komments-reply-drawer":$},fields:{CommentsTable:m},icons:{"indie-mention":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C13.6418 20 15.1681 19.5054 16.4381 18.6571L17.5476 20.3214C15.9602 21.3818 14.0523 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12V13.5C22 15.433 20.433 17 18.5 17C17.2958 17 16.2336 16.3918 15.6038 15.4659C14.6942 16.4115 13.4158 17 12 17C9.23858 17 7 14.7614 7 12C7 9.23858 9.23858 7 12 7C13.1258 7 14.1647 7.37209 15.0005 8H17V13.5C17 14.3284 17.6716 15 18.5 15C19.3284 15 20 14.3284 20 13.5V12ZM12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9Z"></path></svg>',"indie-repost":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 4H21C21.5523 4 22 4.44772 22 5V12H20V6H6V9L1 5L6 1V4ZM18 20H3C2.44772 20 2 19.5523 2 19V12H4V18H18V15L23 19L18 23V20Z"></path></svg>',"indie-sent":'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4.99989 13.9999L4.99976 5L6.99976 4.99997L6.99986 11.9999L17.1717 12L13.222 8.05024L14.6362 6.63603L21.0001 13L14.6362 19.364L13.222 17.9497L17.1717 14L4.99989 13.9999Z"></path></svg>'}})})();
